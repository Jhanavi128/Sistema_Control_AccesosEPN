<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Credencial - EPN</title>
    <link rel="stylesheet" href="/assets/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="card">
            <h2>Mi Credencial Digital</h2>
            <!-- QR Container with High Contrast Quiet Zone -->
            <div id="qrcode" style="
                margin: 20px auto; 
                display: flex; 
                justify-content: center;
                background-color: white;
                padding: 15px;
                border-radius: 10px;
                width: fit-content;
            "></div>

            <!-- Download Button -->
            <button onclick="downloadQR()" class="btn"
                style="background-color: transparent; border: 1px solid #0061ff; color: #0061ff; margin-bottom: 20px;">
                Descargar QR
            </button>

            <h3 id="uName">Cargando...</h3>
            <p id="uCareer" style="color: grey;">...</p>
            <p id="uPeriod" style="font-size: 14px; opacity: 0.8; margin-bottom: 10px;">...</p>
            <p id="uCode" style="font-size: 20px; font-weight: bold;">...</p>

            <button onclick="logout()" class="btn" style="background-color: #ddd; color: #333; margin-top: 10px;">Cerrar
                Sesión</button>
        </div>
    </div>

    <script>
        // Fetch Profile on Load
        window.onload = async function () {
            try {
                const userCode = localStorage.getItem('user_code');
                const headers = { 'ngrok-skip-browser-warning': 'true' };

                if (userCode) {
                    headers['X-User-Code'] = userCode;
                }

                const res = await fetch('/api/profile', {
                    headers: headers
                });

                if (!res.ok) {
                    // If not logged in, redirect to login
                    console.error("Profile fetch failed: " + res.status);
                    window.location.href = '/';
                    return;
                }
                const user = await res.json();

                // Update UI
                document.getElementById('uName').innerText = user.nombre;
                document.getElementById('uCareer').innerText = "Estudiante - " + user.carrera;
                document.getElementById('uPeriod').innerText = "Periodo: " + user.periodo;
                document.getElementById('uCode').innerText = "Código: " + user.codigo;

                // Generate QR
                document.getElementById("qrcode").innerHTML = "";
                new QRCode(document.getElementById("qrcode"), {
                    text: user.codigo, // Dynamic Code!
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

            } catch (e) {
                console.error(e);
                alert("Error cargando perfil");
            }
        };

        function downloadQR() {
            const qrContainer = document.getElementById("qrcode");
            const img = qrContainer.querySelector("img");

            if (img && img.src) {
                const link = document.createElement("a");
                link.href = img.src;
                // Get name safely
                const name = document.getElementById('uName').innerText || "credencial";
                link.download = `credencial_${name.replace(" ", "_")}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("El código QR aún se está generando. Intente de nuevo.");
            }
        }

        function logout() {
            // Simple logout: clear cookie (client side attempt) or just redirect
            // In a real app we would call /logout endpoint to clear httpOnly cookie
            // For now, simple redirect works as the browser manages session often
            // But to be sure, we can set cookie to empty if not HttpOnly, but ours is.
            // We'll rely on simply going to / which shows login form.
            window.location.href = '/';
        }
    </script>
</body>

</html>